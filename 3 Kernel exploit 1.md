# Giới thiệu về kernel

Khi nói đến kernel, điều quan trọng là phải hiểu mục đích của nó để chúng ta có thể hiểu nó có thể dễ bị tấn công như thế nào.

Hạt nhân về cơ bản là một “chương trình máy tính” tạo điều kiện cho sự tương tác giữa phần cứng và phần mềm. Điều này có nghĩa là kernel nằm giữa các ứng dụng (phần mềm) và CPU/bộ nhớ/thiết bị/v.v. (phần cứng). Công việc của kernel là chuyển đổi các yêu cầu đầu vào/đầu ra (I/O) từ phần mềm thành các tập lệnh tương tác giữa phần mềm và phần cứng.

![image](https://github.com/Manh130902/Windows-Privilege-Escalation/assets/93723285/2dd6698a-9c26-47eb-9bcc-d96a8e403025)

Kernel là chương trình đầu tiên được tải sau bootloader. Sau khi tải, nó kiểm soát và điều phối mọi chương trình và quy trình khác, đồng thời đảm bảo rằng bộ nhớ được phân bổ chính xác.

Trong hầu hết các trường hợp, chúng tôi nhận thấy rằng lỗ hổng kernel tồn tại do cách Windows Kernel xử lý các đối tượng trong bộ nhớ. Điều này cho phép kẻ tấn công thực thi mã với các đặc quyền cấp HỆ THỐNG nâng cao.

# Săn lùng lỗ hổng hạt nhân

Trong ví dụ này, chúng tôi đã có được chỗ đứng trên máy Windows 7 với tư cách là người dùng tiêu chuẩn **bob** .

![image](https://github.com/Manh130902/Windows-Privilege-Escalation/assets/93723285/8b819275-1afd-4c82-b66e-53aedb50fe67)

# Liệt kê các khai thác hạt nhân – Phương pháp thủ công
Trong khi liệt kê các lỗ hổng kernel, điều đầu tiên chúng ta cần làm là sử dụng lệnh **systeminfo** để tìm tất cả thông tin về hệ thống. Chúng tôi đang tìm kiếm phiên bản hệ điều hành, kiến trúc và quan trọng nhất là các hotfix (KB) đã được cài đặt.

![image](https://github.com/Manh130902/Windows-Privilege-Escalation/assets/93723285/756f8fb4-e1cc-47b9-97bd-99bad4be585d)

Ở đây chúng ta có thể thấy đây là hệ thống Windows 7 Pro – SP1 7601 – x86 (32-bit). Chúng ta cũng có thể thấy rằng chỉ có một hotfix duy nhất được cài đặt trên máy chủ này.

Để thu thập thông tin về các hotfix được cài đặt trên máy chủ, chúng ta có thể sử dụng lệnh **wmic** sau :

```
wmic qfe get Caption,Description,HotFixID,InstalledOn
```

Ngày của hotfix này rất quan trọng cần lưu ý vì Microsoft đặt cho các lỗ hổng kernel một “tiêu đề”, bao gồm năm lỗ hổng được xác định/vá. Ví dụ: MS10-059 (2010), MS17-010 (2017), v.v.

Từ đây, chúng tôi có thể bắt đầu phân tích những hotfix nào đã được cài đặt và sau đó Google số KB để xác định các hoạt động khai thác kernel KHÔNG sử dụng được do bản vá đó.

Điều này hoạt động tốt; tuy nhiên, nếu có 100, 200, 300 hotfix — hãy quên nó đi! Đây chỉ là một chiến lược phù hợp cho một máy có rất ít bản sửa lỗi được cài đặt.

# Liệt kê các khai thác hạt nhân – Công cụ

Công cụ hoạt động khá tốt để liệt kê các lỗi khai thác kernel điều hành cũ, công cụ đó là Windows Exploit Suggester 2 .

Công cụ này đều hoạt động bằng cách tham chiếu chéo các KB đã cài đặt trên nạn nhân với danh sách các lỗ hổng đã được vá nhờ các KB đó. Từ đó, các công cụ sẽ loại trừ các lỗ hổng đã được vá khỏi đầu ra và chỉ hiển thị cho chúng tôi những lỗ hổng mà máy chủ KHÔNG được vá.

## Windows Exploit Suggester 2

Link download: https://github.com/7Ragnarok7/Windows-Exploit-Suggester-2

Windows Exploit Suggester 2 là một tập lệnh Python mà chúng tôi thực thi từ máy tấn công của mình để liệt kê các lỗ hổng kernel tiềm ẩn trên nạn nhân. Để sử dụng tập lệnh này, trước tiên chúng ta cần chạy lệnh systeminfo trên nạn nhân, sau đó sao chép và dán toàn bộ đầu ra vào tệp TXT trên máy tấn công của chúng ta.

![image](https://github.com/Manh130902/Windows-Privilege-Escalation/assets/93723285/7204fae8-b950-44b6-8bc4-0d78cd9a0b45)

Bây giờ chúng ta đã chuẩn bị sẵn tệp txt, chúng ta có thể cập nhật tệp XLS để đảm bảo danh sách các bản vá được cập nhật; tuy nhiên, vì đây là hệ điều hành cũ chỉ cài đặt một hotfix duy nhất nên sẽ không cần cập nhật vì tháng 4 năm 2021 là thời điểm đủ gần cho nhu cầu của chúng tôi.

Để chạy Windows Exploit Suggester, chúng ta cần cung cấp cho nó tệp TXT bằng lệnh sau:

```
./windows-exploit-suggester.py --database 2021-04-16-mssb.xls --systeminfo win7.txt
```

![image](https://github.com/Manh130902/Windows-Privilege-Escalation/assets/93723285/a1224ad9-64c9-41e6-a1e5-46780c594d52)

Có khá nhiều đầu ra và hầu hết chúng đều không thú vị đối với chúng tôi. Ngoài ra, có một chú thích ở đây cho chúng ta biết liệu có mô-đun nhị phân hoặc Metasploit nào có sẵn cho bất kỳ hoạt động khai thác cụ thể nào hay không.

Chúng tôi có thể thu hẹp điều này để chỉ bao gồm các lỗ hổng mà chúng tôi quan tâm, sẽ có [M] hoặc [E] và sẽ nêu rõ “Elevation of privileges”.

```
./windows-exploit-suggester.py --database 2021-04-16-mssb.xls --systeminfo win7.txt | grep "\[M\]\|\[E\]" | grep "Elevation"
```

![image](https://github.com/Manh130902/Windows-Privilege-Escalation/assets/93723285/3af7eef1-00aa-4c07-8d34-f393dc03f16b)

Sau một chút grep-fu, chúng ta có một danh sách các lỗ hổng hữu ích để kiểm tra.

# Kiểm tra khai thác hạt nhân và nâng cấp lên HỆ THỐNG

Kernel exploit : https://github.com/SecWiki/windows-kernel-exploits

Kho lưu trữ này chứa RẤT NHIỀU tệp nhị phân được biên dịch sẵn cho hầu hết các cách khai thác kernel cũ hơn. Chúng tôi có thể kiểm tra xem hệ thống nào dễ bị tấn công từ đầu ra của các công cụ của chúng tôi, sau đó tải xuống cách khai thác tương ứng từ kho lưu trữ GitHub.

NOTE: Trong danh sách các lỗ hổng kernel, bạn sẽ thấy rằng hầu hết chúng đều sinh ra một phiên bản cmd.exe mới dưới dạng HỆ THỐNG. Mặc dù điều này thật tuyệt nhưng nó chỉ thực tế nếu chúng ta có phiên RDP hoặc một số phương tiện GUI khác để xem shell. May mắn thay, khá nhiều trong số này tạo ra độ cao tại chỗ hoặc lớp vỏ đảo ngược, vì vậy chúng tôi sẽ xem xét cả hai khi chúng tôi thực sự kiểm tra một số cách khai thác này.

## Kernel-exploit (GUI)

Hãy giả sử trong một phút rằng chúng tôi đã tìm thấy thông tin đăng nhập của người dùng bob trong lần liệt kê ban đầu. Chúng tôi cũng nhận thấy rằng RDP đang mở và bob đó là một phần của Nhóm người dùng máy tính từ xa. Kết quả là chúng tôi đã có thể đưa RDP vào máy chủ thành công và hiện có quyền truy cập GUI.

Vì hầu hết các cách khai thác trong danh sách đều sinh ra một phiên bản cmd.exe mới dưới dạng HỆ THỐNG, điều này khiến kernel khai thác EASSSSSY khi chúng ta có GUI để làm việc.
Ví dụ: từ đầu ra của gợi ý và WES, chúng ta có thể thấy rằng các cách khai thác duy nhất hiển thị cho cả hai là MS15-051 và MS16-016.

Vì cả hai thứ này đều xuất hiện từ mỗi công cụ nên chúng tôi có thể kiểm tra xem liệu chúng có được liệt kê trên trang GitHub hay không. - mà chúng ta có thể thấy rằng cả hai đều như vậy.

![image](https://github.com/Manh130902/Windows-Privilege-Escalation/assets/93723285/b15510ed-b684-4413-b34e-fd2f14084130)

Hiện tại, chúng ta chỉ cần tải MS15-051 xuống máy tấn công của chúng ta và sau đó gửi nó cho nạn nhân.
Tệp nhị phân biên dịch trước của MS15-051 có tên Taihou32.exe nhưng tôi đã đổi tên thành MS15-051.exe trước khi chuyển nó cho nạn nhân.

![image](https://github.com/Manh130902/Windows-Privilege-Escalation/assets/93723285/23f4aa92-0d71-44e9-a489-4bf9b460ac5f)

Bây giờ khi chúng ta chạy tệp thực thi, một shell mới sẽ mở ra dưới dạng HỆ THỐNG!

![image](https://github.com/Manh130902/Windows-Privilege-Escalation/assets/93723285/09af2bdf-dc63-43d2-81e2-e8512f50a849)

Nó thực sự đơn giản như vậy!

## Kernel exploit – reverse shell(no GUI)

Ví dụ: từ đầu ra của gợi ý và WES, chúng ta có thể thấy rằng các cách khai thác duy nhất hiển thị là và MS16-016 và chúng ta sẽ thấy rằng chúng ta không có quyền truy cập GUI.

Chúng tôi có thể lấy một bản sao của hoạt động khai thác này trên máy tấn công của mình và sau đó chuyển nó cho nạn nhân

![image](https://github.com/Manh130902/Windows-Privilege-Escalation/assets/93723285/ac0d1992-8d4f-4002-bf17-060314e4d16f)

Mã nhị phân của MS16-016 là EoP.exe nên mình đổi tên thành MS16-016.exe.

Cần phải đề cập rằng tệp nhị phân MS16-016 cần tệp Shellcode.dll để hoạt động. Chúng tôi sẽ cần chuyển cả hai tập tin vào nạn nhân của mình.

![image](https://github.com/Manh130902/Windows-Privilege-Escalation/assets/93723285/fc26a1e5-d0b2-4a96-9c0e-7039078123d3)

Bây giờ chúng ta đã có cả hai tệp trên nạn nhân, chúng ta có thể thực thi MS16-016.exe và nó sẽ tạo ra một shell SYSTEM cho chúng ta.

![image](https://github.com/Manh130902/Windows-Privilege-Escalation/assets/93723285/ab083522-bf18-429b-a08b-61122ef17286)
